# redstne.dash — Traefik deployment
#
# Usage:
#   1. docker network create traefik        (once, shared with other stacks)
#   2. Copy .env.example → .env and set:
#        MC_RCON_PASSWORD=...
#        BASE_URL=https://dash.example.com
#        SECURE_COOKIES=true
#        TRAEFIK_DOMAIN=dash.example.com
#        TRAEFIK_ACME_EMAIL=you@example.com
#   3. docker compose -f docker-compose.traefik.yml up -d

services:
  # ── Traefik reverse proxy ──────────────────────────────────────────────────
  traefik:
    image: traefik:v3.3
    restart: unless-stopped
    command:
      - --api.dashboard=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=traefik
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure.http.tls.certresolver=letsencrypt
      - --certificatesresolvers.letsencrypt.acme.email=${TRAEFIK_ACME_EMAIL:?TRAEFIK_ACME_EMAIL is required}
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.letsencrypt.acme.tlschallenge=true
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt
    networks:
      - traefik

  # ── redstne Dashboard ──────────────────────────────────────────────────────
  dashboard:
    image: ghcr.io/redstne/dash:latest
    restart: unless-stopped
    environment:
      NODE_ENV: production
      DB_PATH: /data/redstne.db
      BASE_URL: ${BASE_URL:?BASE_URL is required (e.g. https://dash.example.com)}
      SECURE_COOKIES: "true"
      MC_SERVER_1_NAME: ${MC_SERVER_1_NAME:-Minecraft}
      MC_SERVER_1_HOST: dash-minecraft-1
      MC_SERVER_1_PORT: 25575
      MC_SERVER_1_PASSWORD: ${MC_RCON_PASSWORD:?MC_RCON_PASSWORD is required}
      MC_SERVER_1_LOG_PATH: /data/mc/logs/latest.log
    volumes:
      - ./data:/data
      - minecraft_data:/data/mc
    labels:
      - traefik.enable=true
      # HTTP router
      - traefik.http.routers.redstne.rule=Host(`${TRAEFIK_DOMAIN:?TRAEFIK_DOMAIN is required}`)
      - traefik.http.routers.redstne.entrypoints=websecure
      - traefik.http.routers.redstne.tls.certresolver=letsencrypt
      - traefik.http.services.redstne.loadbalancer.server.port=3001
    networks:
      - traefik
      - redstne

  # ── Minecraft server ───────────────────────────────────────────────────────
  minecraft:
    image: itzg/minecraft-server:latest
    restart: unless-stopped
    environment:
      EULA: "TRUE"
      MEMORY: 4G
      ENABLE_RCON: "true"
      RCON_PASSWORD: ${MC_RCON_PASSWORD:?MC_RCON_PASSWORD is required}
      RCON_PORT: 25575
      TYPE: PAPER
      VERSION: LATEST
      PLUGINS_FILE: /data/redstne-plugins.txt
    ports:
      - "25565:25565"
    volumes:
      - minecraft_data:/data
    networks:
      - redstne

volumes:
  minecraft_data:
  traefik_letsencrypt:

networks:
  traefik:
    external: true   # shared with other stacks — create once with: docker network create traefik
  redstne:
    driver: bridge
